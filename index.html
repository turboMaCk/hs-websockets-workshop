<!doctype html>
<head>
  <title>Haskell Websockets</title>
</head>
<body>
  <div id="message-list"></div>
  <form id="message">
    <textarea id="message-text"></textarea>
    <button type="submit">Send</button>
  </form>
  <script>

    let token = localStorage.getItem("token");
    let name;

    if (!token) {
        name = prompt("Please enter your name", "Jane Doe");
        if (!name) throw("not a name");
    }

    const ws = new WebSocket("ws://127.0.0.1:3000");

    ws.onopen = function(e) {
        console.log("[open] Connection established");
        console.log("Sending to server");
        let firstMessage;

        if (token) {
            firstMessage = {
                tag: "JoinToken",
                joinToken: token
            };
        } else {
            firstMessage = {
                tag: "JoinNew",
                joinName: name
            };
        }
        ws.send(JSON.stringify(firstMessage));
    };

    const messages = document.getElementById("message-list");
    let gotMessages = false;

    function addMessage(obj) {
        const div = document.createElement("div");
        div.innerText = `${obj.messageUserName}: ${obj.messageText}`;
        messages.append(div);
    }

    ws.onmessage = function(event) {
        console.log(`[message] Data received from server: ${event.data}`);

        const data = JSON.parse(event.data);

        if (data === "SessionInvalid") {
            localStorage.removeItem("token");
            return location.reload();
        }

        if (data === "MessageInvalid") {
            return alert("Communication Error");
        }

        // handle fist message which contains session token
        if (!token) {
            token = data;
            localStorage.setItem("token", token);
            console.debug("Token stored", token)
        } else {
            if (gotMessages) {
                addMessage(data);
            } else {
                data.reverse().forEach(addMessage);
                gotMessages = true;
            }
        }
    };

    ws.onclose = function(event) {
        if (event.wasClean) {
            console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
        } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            console.log('[close] Connection died');
        }
    };

    ws.onerror = function(error) {
        console.log(`[error] ${error.message}`);
    };

    const form = document.getElementById("message");
    const textarea = document.getElementById("message-text");

    function sendMessage() {
        ws.send(JSON.stringify(textarea.value));
        textarea.value = "";
    }

    form.addEventListener("submit", (event) => {
        event.preventDefault();
        sendMessage();
    });

    textarea.addEventListener("keyup", (event) => {
        if (event.keyCode === 13 && event.ctrlKey) {
            event.preventDefault();
            sendMessage();
        }
    });
  </script>
</body>
